// ?R?c?A?N?V??????{

#include "DxLib.h"
#include <math.h>

// ???l??` -------------------------------------------------------------------------------------

// ?L?????N?^?[???????
#define CHARA_PLAY_ANIM_SPEED 250.0f   // ?A?j???[?V???????x
#define CHARA_MOVE_SPEED 30.0f		   // ??????x
#define CHARA_ANIM_BLEND_SPEED 0.1f	   // ?A?j???[?V??????u?????h???É÷????x
#define CHARA_ANGLE_SPEED 0.2f		   // ?p?x?É÷????x
#define CHARA_JUMP_POWER 100.0f		   // ?W?????v??
#define CHARA_FALL_UP_POWER 20.0f	   // ?????O????????W?????v??
#define CHARA_GRAVITY 3.0f			   // ?d??
#define CHARA_MAX_HITCOLL 2048		   // ????????R???W?????|???S??????
#define CHARA_ENUM_DEFAULT_SIZE 800.0f // ?????|???S?????o??g?p??????????T?C?Y
#define CHARA_HIT_WIDTH 200.0f		   // ????????J?v?Z??????a
#define CHARA_HIT_HEIGHT 700.0f		   // ????????J?v?Z???????
#define CHARA_HIT_TRYNUM 16			   // ??????o???????????s??
#define CHARA_HIT_SLIDE_LENGTH 5.0f	   // ??x???????o????????X???C?h?????˚–??
#define CHARA_HIT_PUSH_POWER 40.0f	   // ?L?????N?^?[???m??????????????????o??????
#define CHARA_SHADOW_SIZE 200.0f	   // ?e?????
#define CHARA_SHADOW_HEIGHT 700.0f	   // ?e??????????

// ?J??????W???`
#define CAMERA_ANGLE_SPEED 0.05f		   // ????x
#define CAMERA_PLAYER_TARGET_HEIGHT 400.0f // ?v???C???[???W??????????????u????_?????
#define CAMERA_PLAYER_LENGTH 1600.0f	   // ?v???C???[??????
#define CAMERA_COLLISION_SIZE 50.0f		   // ?J?????????????T?C?Y

// ?v???C???[?L??????O?L????????
#define NOTPLAYER_NUM 4			// ?v???C???[??O??L???????
#define NOTPLAYER_MOVETIME 120	// ?????????????????
#define NOTPLAYER_JUMPRATIO 250 // ?v???C???[??O??L???????W?????v????m??

// ?\?????` -------------------------------------------------------------------------------------

// ??????\????
struct PADINPUT
{
	int NowInput;  // ????????
	int EdgeInput; // ?????t???[??????????{?^?????r?b?g??????????????l
};

// ?L?????N?^?[???
struct CHARA
{
	VECTOR Position;			// ???W
	VECTOR TargetMoveDirection; // ???f?????????????????x?N?g??
	float Angle;				// ???f??????????????????p?x
	float JumpPower;			// ?x??????????x
	int ModelHandle;			// ???f???n???h??
	int State;					// ???( 0:?????~???  1:????  2:?W?????v )

	int PlayAnim1;		  // ??????????A?j???[?V?????P??A?^?b?`???( -1:?????A?j???[?V???????A?^?b?`????????? )
	float AnimPlayCount1; // ??????????A?j???[?V?????P????????
	int PlayAnim2;		  // ??????????A?j???[?V?????Q??A?^?b?`???( -1:?????A?j???[?V???????A?^?b?`????????? )
	float AnimPlayCount2; // ??????????A?j???[?V?????Q????????
	float AnimBlendRate;  // ??????????A?j???[?V?????P??Q??u?????h??
};

// ?v???C???[???\????
struct PLAYER
{
	CHARA CharaInfo; // ?L?????N?^?[???
};

// ?v???C???[??O?L???????\????
struct NOTPLAYER
{
	CHARA CharaInfo; // ?L?????N?^?[???
	int MoveTime;	 // ???????
	float MoveAngle; // ???????
};

// ?L?????N?^?[??????
struct CHARA_COMMON
{
	int BaseModelHandle; // ?????h???????f???n???h??
	int ShadowHandle;	 // ?e?`??p??O???t?B?b?N?n???h??
};

// ?X?e?[?W???\????
struct STAGE
{
	int ModelHandle; // ???f???n???h??
};

// ?J???????\????
struct CAMERA
{
	float AngleH;  // ?????p?x
	float AngleV;  // ?????p?x
	VECTOR Eye;	   // ?J???????W
	VECTOR Target; // ?????_???W
};

// ????v???g?^?C?v?? ---------------------------------------------------------------------------

void Input_Process(void); // ???????

void Chara_Initialize(CHARA *ch, VECTOR Position);					// ?L?????N?^?[???????
void Chara_Terminate(CHARA *ch);									// ?L?????N?^?[???n??
void Chara_Process(CHARA *ch, VECTOR MoveVec, int JumpFlag);		// ?L?????N?^?[?????
void Chara_Move(CHARA *ch, VECTOR MoveVector);						// ?L?????N?^?[????????
void Chara_Collision(CHARA *ch, VECTOR *ch_MoveVec, CHARA *chk_ch); // ?L?????N?^?[?????????????ñ¥???o?????????s??( chk_ch ?? ch ??????????????? ch ??????? )
void Chara_AngleProcess(CHARA *ch);									// ?L?????N?^?[??????????ËY??
void Chara_PlayAnim(CHARA *ch, int PlayAnim);						// ?L?????N?^?[??V????A?j???[?V?????????????
void Chara_AnimProcess(CHARA *ch);									// ?L?????N?^?[??A?j???[?V????????
void Chara_ShadowRender(CHARA *ch);									// ?L?????N?^?[??e??`??

void Player_Initialize(void); // ?v???C???[???????
void Player_Terminate(void);  // ?v???C???[???n??
void Player_Process(void);	  // ?v???C???[?????

void Stage_Initialize(void); // ?X?e?[?W???????????
void Stage_Terminate(void);	 // ?X?e?[?W???n??????

void Camera_Initialize(void); // ?J???????????????
void Camera_Process(void);	  // ?J?????????

void Render_Process(void); // ?`????

// ????? ---------------------------------------------------------------------------------------

PADINPUT inp;				  // ???????????
PLAYER pl;					  // ?v???C???[????????
NOTPLAYER npl[NOTPLAYER_NUM]; // ?v???C???[??????L??????????
CHARA_COMMON chcmn;			  // ?L?????N?^?[????????????
STAGE stg;					  // ?X?e?[?W????????
CAMERA cam;					  // ?J????????????

// ??????? ---------------------------------------------------------------------------------------

// ???????
void Input_Process(void)
{
	int Old;

	// ????O??t???[???????????????????
	Old = inp.NowInput;

	// ????????????èÔ
	inp.NowInput = GetJoypadInputState(DX_INPUT_KEY_PAD1);

	// ????t???[????V??????????{?^????r?b?g?????????????l?? EdgeInput ????????
	inp.EdgeInput = inp.NowInput & ~Old;
}

// ?L?????N?^?[??????????????
void CharaCommon_Initialize(void)
{
	// ???f?????????
	chcmn.BaseModelHandle = MV1LoadModel("DxChara.x");

	// ?e?`??p??????????
	chcmn.ShadowHandle = LoadGraph("Shadow.tga");
}

// ?L?????N?^?[????????n??
void CharaCommon_Terminate(void)
{
	// ???f?????
	MV1DeleteModel(chcmn.BaseModelHandle);

	// ?e?p?????
	DeleteGraph(chcmn.ShadowHandle);
}

// ?L?????N?^?[???????
void Chara_Initialize(CHARA *ch, VECTOR Position)
{
	// ???????W????_
	ch->Position = Position;

	// ??]?l??O
	ch->Angle = 0.0f;

	// ?W?????v???????????O
	ch->JumpPower = 0.0f;

	// ???f???n???h?????
	ch->ModelHandle = MV1DuplicateModel(chcmn.BaseModelHandle);

	// ?????????u?????~??v???
	ch->State = 0;

	// ????????w??????
	ch->TargetMoveDirection = VGet(1.0f, 0.0f, 0.0f);

	// ?A?j???[?V??????u?????h??????????
	ch->AnimBlendRate = 1.0f;

	// ?????????A?j???[?V??????A?^?b?`??????????????
	ch->PlayAnim1 = -1;
	ch->PlayAnim2 = -1;

	// ?????????????A?j???[?V?????????
	Chara_PlayAnim(ch, 4);
}

// ?L?????N?^?[???n??
void Chara_Terminate(CHARA *ch)
{
	// ???f?????
	MV1DeleteModel(ch->ModelHandle);
}

// ?L?????N?^?[?????
void Chara_Process(CHARA *ch, VECTOR MoveVec, int JumpFlag)
{
	int MoveFlag; // ????????????????t???O( 1:???????  0:??????????? )

	// ???[?g?t???[????y???????????p?????[?^????????
	{
		MATRIX LocalMatrix;

		// ???[?U?[?s???????????
		MV1ResetFrameUserLocalMatrix(ch->ModelHandle, 2);

		// ???????[?g?t???[????s????èÔ????
		LocalMatrix = MV1GetFrameLocalMatrix(ch->ModelHandle, 2);

		// ?y??????????s???????????????
		LocalMatrix.m[3][2] = 0.0f;

		// ???[?U?[?s????????s????????????????s??????[?g?t???[????Z?b?g????
		MV1SetFrameUserLocalMatrix(ch->ModelHandle, 2, LocalMatrix);
	}

	// ????????????????t???O???Z?b?g?A???????????????????u??????????v??\???P?????
	MoveFlag = 0;
	if (MoveVec.x < -0.001f || MoveVec.x > 0.001f ||
		MoveVec.y < -0.001f || MoveVec.y > 0.001f ||
		MoveVec.z < -0.001f || MoveVec.z > 0.001f)
	{
		MoveFlag = 1;
	}

	// ?L?????N?^?[??????u?W?????v?v??????A????W?????v?t???O?????????????W?????v????
	if (ch->State != 2 && JumpFlag == 1)
	{
		// ?????u?W?????v?v?????
		ch->State = 2;

		// ?x??????????x???Z?b?g
		ch->JumpPower = CHARA_JUMP_POWER;

		// ?W?????v?A?j???[?V????????
		Chara_PlayAnim(ch, 2);
	}

	// ????{?^?????????????????????????
	if (MoveFlag)
	{
		// ????x?N?g????K????????????L?????N?^?[????????????????????
		ch->TargetMoveDirection = VNorm(MoveVec);

		// ?????????u?????~???v??????????
		if (ch->State == 0)
		{
			// ????A?j???[?V?????????????
			Chara_PlayAnim(ch, 1);

			// ?????u????v?????
			ch->State = 1;
		}
	}
	else
	{
		// ????t???[????????????????A????????u????v????????
		if (ch->State == 1)
		{
			// ?????~??A?j???[?V?????????????
			Chara_PlayAnim(ch, 4);

			// ?????u?????~??v?????
			ch->State = 0;
		}
	}

	// ?????u?W?????v?v?????
	if (ch->State == 2)
	{
		// ?x??????????x???d??????Z????
		ch->JumpPower -= CHARA_GRAVITY;

		// ????????????????????????????A?j???[?V???????????p??????????????
		if (ch->JumpPower < 0.0f && MV1GetAttachAnim(ch->ModelHandle, ch->PlayAnim1) == 2)
		{
			// ??????????A?j???[?V?????????????
			Chara_PlayAnim(ch, 3);
		}

		// ????x?N?g????x???????x??????????x?????
		MoveVec.y = ch->JumpPower;
	}

	// ?L?????N?^?[????????????f???????????????
	Chara_AngleProcess(ch);

	// ????x?N?g????????R???W???????l???????L?????N?^?[?????
	Chara_Move(ch, MoveVec);

	// ?A?j???[?V????????
	Chara_AnimProcess(ch);
}

// ?L?????N?^?[????????
void Chara_Move(CHARA *ch, VECTOR MoveVector)
{
	int i, j, k;								   // ??p?J?E???^???
	int MoveFlag;								   // ?????????????????????????t???O( ?O:???????????  ?P:??????? )
	int HitFlag;								   // ?|???S?????????????????????L????????????g?????( ?O:????????????  ?P:???????? )
	MV1_COLL_RESULT_POLY_DIM HitDim;			   // ?L?????N?^?[?????????|???S???????o?????????????????????????\????
	int KabeNum;								   // ??|???S??????f?????|???S?????
	int YukaNum;								   // ???|???S??????f?????|???S?????
	MV1_COLL_RESULT_POLY *Kabe[CHARA_MAX_HITCOLL]; // ??|???S??????f?????|???S????\?????A?h???X????????????????|?C???^?z??
	MV1_COLL_RESULT_POLY *Yuka[CHARA_MAX_HITCOLL]; // ???|???S??????f?????|???S????\?????A?h???X????????????????|?C???^?z??
	MV1_COLL_RESULT_POLY *Poly;					   // ?|???S????\?????A?N?Z?X???????g?p????|?C???^( ?g???????????????????v???O???????????????E?E?E )
	HITRESULT_LINE LineRes;						   // ??????|???S???????????????????????\????
	VECTOR OldPos;								   // ????O????W
	VECTOR NowPos;								   // ????????W

	// ????O????W????
	OldPos = ch->Position;

	// ????????W???Z?o
	NowPos = VAdd(ch->Position, MoveVector);

	// ?L?????N?^?[?????????X?e?[?W?|???S?????èÔ????
	// ( ???o????????????????l?????? )
	HitDim = MV1CollCheck_Sphere(stg.ModelHandle, -1, ch->Position, CHARA_ENUM_DEFAULT_SIZE + VSize(MoveVector));

	// x????y???????? 0.01f ?????????????u????????v?t???O???P?????
	if (fabs(MoveVector.x) > 0.01f || fabs(MoveVector.z) > 0.01f)
	{
		MoveFlag = 1;
	}
	else
	{
		MoveFlag = 0;
	}

	// ???o?????|???S??????|???S??( ?w?y??????????|???S?? )?????|???S??( ?w?y??????????????|???S?? )????f????
	{
		// ??|???S??????|???S?????????????????
		KabeNum = 0;
		YukaNum = 0;

		// ???o?????|???S??????????J????
		for (i = 0; i < HitDim.HitNum; i++)
		{
			// ?w?y?????????????????|???S????@????x???????O?????????????????????f????
			if (HitDim.Dim[i].Normal.y < 0.000001f && HitDim.Dim[i].Normal.y > -0.000001f)
			{
				// ??|???S??????f??????????A?L?????N?^?[??x???W?{?P?D?O????????|???S??????????????s??
				if (HitDim.Dim[i].Position[0].y > ch->Position.y + 1.0f ||
					HitDim.Dim[i].Position[1].y > ch->Position.y + 1.0f ||
					HitDim.Dim[i].Position[2].y > ch->Position.y + 1.0f)
				{
					// ?|???S???????????????E????B??????????????|???S????z?????
					if (KabeNum < CHARA_MAX_HITCOLL)
					{
						// ?|???S????\?????A?h???X???|???S???|?C???^?z?????????
						Kabe[KabeNum] = &HitDim.Dim[i];

						// ??|???S??????????Z????
						KabeNum++;
					}
				}
			}
			else
			{
				// ?|???S???????????????E????B??????????????|???S????z?????
				if (YukaNum < CHARA_MAX_HITCOLL)
				{
					// ?|???S????\?????A?h???X?????|???S???|?C???^?z?????????
					Yuka[YukaNum] = &HitDim.Dim[i];

					// ???|???S??????????Z????
					YukaNum++;
				}
			}
		}
	}

	// ??|???S??????????????
	if (KabeNum != 0)
	{
		// ???????????????????t???O??????????u?????????????v????????
		HitFlag = 0;

		// ??????????????????????
		if (MoveFlag == 1)
		{
			// ??|???S??????????J????
			for (i = 0; i < KabeNum; i++)
			{
				// i?????|???S????A?h???X???|???S???|?C???^?z???èÔ
				Poly = Kabe[i];

				// ?|???S????L?????N?^?[??????????????????????J?E???g??
				if (HitCheck_Capsule_Triangle(NowPos, VAdd(NowPos, VGet(0.0f, CHARA_HIT_HEIGHT, 0.0f)), CHARA_HIT_WIDTH, Poly->Position[0], Poly->Position[1], Poly->Position[2]) == FALSE)
					continue;

				// ???????????|???S????L?????N?^?[????????????????????????A?|???S????????????t???O????
				HitFlag = 1;

				// ???????????????????????????????????????
				{
					VECTOR SlideVec; // ?L?????N?^?[???X???C?h??????x?N?g??

					// ?i?s?????x?N?g?????|???S????@???x?N?g?????????x?N?g?????Z?o
					SlideVec = VCross(MoveVector, Poly->Normal);

					// ?Z?o?????x?N?g?????|???S????@???x?N?g?????????x?N?g?????Z?o?A????
					// ????????????????????????????????x?N?g??
					SlideVec = VCross(Poly->Normal, SlideVec);

					// ?????????O????W????????????V??????W?????
					NowPos = VAdd(OldPos, SlideVec);
				}

				// ?V?????????W???|???S???????????????????????????
				for (j = 0; j < KabeNum; j++)
				{
					// j?????|???S????A?h???X???|???S???|?C???^?z???èÔ
					Poly = Kabe[j];

					// ????????????‡}?[?v???çb????
					if (HitCheck_Capsule_Triangle(NowPos, VAdd(NowPos, VGet(0.0f, CHARA_HIT_HEIGHT, 0.0f)), CHARA_HIT_WIDTH, Poly->Position[0], Poly->Position[1], Poly->Position[2]) == TRUE)
						break;
				}

				// j ?? KabeNum ????????????|???S?????????????????????????????
				// ???????????t???O??|?????????[?v???çb????
				if (j == KabeNum)
				{
					HitFlag = 0;
					break;
				}
			}
		}
		else
		{
			// ??????????????????

			// ??|???S??????????J????
			for (i = 0; i < KabeNum; i++)
			{
				// i?????|???S????A?h???X???|???S???|?C???^?z???èÔ
				Poly = Kabe[i];

				// ?|???S???????????????????????t???O?????????[?v???çb????
				if (HitCheck_Capsule_Triangle(NowPos, VAdd(NowPos, VGet(0.0f, CHARA_HIT_HEIGHT, 0.0f)), CHARA_HIT_WIDTH, Poly->Position[0], Poly->Position[1], Poly->Position[2]) == TRUE)
				{
					HitFlag = 1;
					break;
				}
			}
		}

		// ??????????????????ñ¥???o?????????s??
		if (HitFlag == 1)
		{
			// ??????????o????????????????????J????
			for (k = 0; k < CHARA_HIT_TRYNUM; k++)
			{
				// ??|???S??????????J????
				for (i = 0; i < KabeNum; i++)
				{
					// i?????|???S????A?h???X???|???S???|?C???^?z???èÔ
					Poly = Kabe[i];

					// ?L?????N?^?[???????????????
					if (HitCheck_Capsule_Triangle(NowPos, VAdd(NowPos, VGet(0.0f, CHARA_HIT_HEIGHT, 0.0f)), CHARA_HIT_WIDTH, Poly->Position[0], Poly->Position[1], Poly->Position[2]) == FALSE)
						continue;

					// ?????????????K?ïc?????L?????N?^?[????@????????????????
					NowPos = VAdd(NowPos, VScale(Poly->Normal, CHARA_HIT_SLIDE_LENGTH));

					// ???????????|???S?????G???????????????
					for (j = 0; j < KabeNum; j++)
					{
						// ????????????‡}?[?v?????
						Poly = Kabe[j];
						if (HitCheck_Capsule_Triangle(NowPos, VAdd(NowPos, VGet(0.0f, CHARA_HIT_HEIGHT, 0.0f)), CHARA_HIT_WIDTH, Poly->Position[0], Poly->Position[1], Poly->Position[2]) == TRUE)
							break;
					}

					// ?S???|???S???????????????????????????[?v?I??
					if (j == KabeNum)
						break;
				}

				// i ?? KabeNum ?????????S????|???S????????o?????????O??S????|???S?????G????????????????????????[?v???çb????
				if (i != KabeNum)
					break;
			}
		}
	}

	// ???|???S????????????
	if (YukaNum != 0)
	{
		// ?W?????v????????????????????
		if (ch->State == 2 && ch->JumpPower > 0.0f)
		{
			float MinY;

			// ?V???????????ËY?????s??

			// ?????V?????????????p???????????
			MinY = 0.0f;

			// ?????????????????t???O????????????????????O????????
			HitFlag = 0;

			// ???|???S??????????J????
			for (i = 0; i < YukaNum; i++)
			{
				// i??????|???S????A?h???X?????|???S???|?C???^?z???èÔ
				Poly = Yuka[i];

				// ???îY?????????????|???S?????G???????????????
				LineRes = HitCheck_Line_Triangle(NowPos, VAdd(NowPos, VGet(0.0f, CHARA_HIT_HEIGHT, 0.0f)), Poly->Position[0], Poly->Position[1], Poly->Position[2]);

				// ??G?????????????å°???????
				if (LineRes.HitFlag == FALSE)
					continue;

				// ????|???S??????????????A??????????o?????V??|???S???????????????????
				if (HitFlag == 1 && MinY < LineRes.Position.y)
					continue;

				// ?|???S????????????t???O????
				HitFlag = 1;

				// ??G?????x???W????????
				MinY = LineRes.Position.y;
			}

			// ??G?????|???S?????????????????????????
			if (HitFlag == 1)
			{
				// ??G????????L?????N?^?[??x???W???G???W??????X?V
				NowPos.y = MinY - CHARA_HIT_HEIGHT;

				// ?x??????????x????]
				ch->JumpPower = -ch->JumpPower;
			}
		}
		else
		{
			float MaxY;

			// ???~?????W?????v??????????????

			// ???|???S????????????????????t???O??|???????
			HitFlag = 0;

			// ?????????|???S??????????????p???????????
			MaxY = 0.0f;

			// ???|???S??????????J????
			for (i = 0; i < YukaNum; i++)
			{
				// i??????|???S????A?h???X?????|???S???|?C???^?z???èÔ
				Poly = Yuka[i];

				// ?W?????v?????????????????
				if (ch->State == 2)
				{
					// ?W?????v??????????îY????????????u?????????????????
					LineRes = HitCheck_Line_Triangle(VAdd(NowPos, VGet(0.0f, CHARA_HIT_HEIGHT, 0.0f)), VAdd(NowPos, VGet(0.0f, -1.0f, 0.0f)), Poly->Position[0], Poly->Position[1], Poly->Position[2]);
				}
				else
				{
					// ???????????????îY?˙b??????????u?????????????????( ?X???????????s???????????? )
					LineRes = HitCheck_Line_Triangle(VAdd(NowPos, VGet(0.0f, CHARA_HIT_HEIGHT, 0.0f)), VAdd(NowPos, VGet(0.0f, -40.0f, 0.0f)), Poly->Position[0], Poly->Position[1], Poly->Position[2]);
				}

				// ?????????????????å°???????
				if (LineRes.HitFlag == FALSE)
					continue;

				// ????????????|???S????????A??????????o???????|???S??????????????????
				if (HitFlag == 1 && MaxY > LineRes.Position.y)
					continue;

				// ?|???S????????????t???O????
				HitFlag = 1;

				// ??G?????x???W????????
				MaxY = LineRes.Position.y;
			}

			// ???|???S??????????????????????????
			if (HitFlag == 1)
			{
				// ??????????

				// ??G?????|???S??????????x???W???L?????N?^?[??x???W?????
				NowPos.y = MaxY;

				// ?x?????????????x??O??
				ch->JumpPower = 0.0f;

				// ?????W?????v??????????????n???????
				if (ch->State == 2)
				{
					// ?????????????????????n????????????A?j???[?V????????
					if (MoveFlag)
					{
						// ???????????????????
						Chara_PlayAnim(ch, 1);
						ch->State = 1;
					}
					else
					{
						// ???????????????????~?????
						Chara_PlayAnim(ch, 4);
						ch->State = 0;
					}

					// ???n????A?j???[?V??????u?????h??s????
					ch->AnimBlendRate = 1.0f;
				}
			}
			else
			{
				// ???R???W??????????????????????W?????v???????????????
				if (ch->State != 2)
				{
					// ?W?????v???????
					ch->State = 2;

					// ???????????W?????v????
					ch->JumpPower = CHARA_FALL_UP_POWER;

					// ?A?j???[?V????????????????????
					Chara_PlayAnim(ch, 3);
				}
			}
		}
	}

	// ?V???????W????????
	ch->Position = NowPos;

	// ?L?????N?^?[????f??????W???X?V????
	MV1SetPosition(ch->ModelHandle, ch->Position);

	// ???o?????L?????N?^?[??????|???S???????J??????
	MV1CollResultPolyDimTerminate(HitDim);
}

// ?L?????N?^?[?????????????ñ¥???o?????????s??( chk_ch ?? ch ??????????????? ch ??????? )
void Chara_Collision(CHARA *ch, VECTOR *ch_MoveVec, CHARA *chk_ch)
{
	VECTOR ChkChToChVec;
	VECTOR PushVec;
	VECTOR ChPosition;
	float Length;

	// ?????? ch ????W???Z?o,ch_MoveVec??????t???[?????????,ch->Position??O?t???[?????u?BPosition???????????Collision???s??
	ChPosition = VAdd(ch->Position, *ch_MoveVec);

	// ?????????????????å°???????
	if (HitCheck_Capsule_Capsule(
			ChPosition, VAdd(ChPosition, VGet(0.0f, CHARA_HIT_HEIGHT, 0.0f)), CHARA_HIT_WIDTH,
			chk_ch->Position, VAdd(chk_ch->Position, VGet(0.0f, CHARA_HIT_HEIGHT, 0.0f)), CHARA_HIT_WIDTH) == TRUE)
	{
		// ????????????? ch ?? chk ???·{??ËY????????

		// chk_ch ???? ch ???x?N?g?????Z?o
		ChkChToChVec = VSub(ChPosition, chk_ch->Position);

		// ?x????????
		ChkChToChVec.y = 0.0f;

		// ??l????????Z?o
		Length = VSize(ChkChToChVec);

		// chk_ch ???? ch ???x?N?g????K??( ?x?N?g????????? 1.0f ????? )
		PushVec = VScale(ChkChToChVec, 1.0f / Length);

		// ?????o?????????Z?o?A??????l??????????l??????????????l??????o????????????????????A??????„Î?????????????????
		// ???????????????????A?J?v?Z??????a??????????çΩ??O???????????s??(2?L??????????a??CHARA_HIT_WIDTH?????)
		if (Length - CHARA_HIT_WIDTH * 2.0f + CHARA_HIT_PUSH_POWER > 0.0f)
		{
			float TempY;

			TempY = ChPosition.y;
			ChPosition = VAdd(chk_ch->Position, VScale(PushVec, CHARA_HIT_WIDTH * 2.0f));

			// ?x???W??É÷????????
			ChPosition.y = TempY;
		}
		else
		{
			// ?????o??
			ChPosition = VAdd(ChPosition, VScale(PushVec, CHARA_HIT_PUSH_POWER));
		}
	}

	// ????????????????x?N?g?????Z?b?g(??I?I??v???C???[??Position??????????A?O???v???C???[???u??????????A?????t???[?????I?I????????Z?o????)
	*ch_MoveVec = VSub(ChPosition, ch->Position);
}

// ?L?????N?^?[??????????ËY??
void Chara_AngleProcess(CHARA *ch)
{
	float TargetAngle; // ??W?p?x
	float SaAngle;	   // ??W?p?x??????p?x????

	// ??W??????x?N?g??????p?x?l???Z?o????
	TargetAngle = atan2(ch->TargetMoveDirection.x, ch->TargetMoveDirection.z);

	// ??W??p?x??????p?x??????????o??
	{
		// ?????P????????Z
		SaAngle = TargetAngle - ch->Angle;

		// ??????????????????????P?W?O?x?????Á∑?????????
		// ????l???P?W?O?x?????????????C??????
		if (SaAngle < -DX_PI_F)
		{
			SaAngle += DX_TWO_PI_F;
		}
		else if (SaAngle > DX_PI_F)
		{
			SaAngle -= DX_TWO_PI_F;
		}
	}

	// ?p?x??????O???????
	if (SaAngle > 0.0f)
	{
		// ?????v???X????????
		SaAngle -= CHARA_ANGLE_SPEED;
		if (SaAngle < 0.0f)
		{
			SaAngle = 0.0f;
		}
	}
	else
	{
		// ?????}?C?i?X????????
		SaAngle += CHARA_ANGLE_SPEED;
		if (SaAngle > 0.0f)
		{
			SaAngle = 0.0f;
		}
	}

	// ???f????p?x???X?V
	ch->Angle = TargetAngle - SaAngle;
	MV1SetRotationXYZ(ch->ModelHandle, VGet(0.0f, ch->Angle + DX_PI_F, 0.0f));
}

// ?L?????N?^?[??V????A?j???[?V?????????????
void Chara_PlayAnim(CHARA *ch, int PlayAnim)
{
	// ?????????[?V?????Q???L??????????f?^?b?`????
	if (ch->PlayAnim2 != -1)
	{
		MV1DetachAnim(ch->ModelHandle, ch->PlayAnim2);
		ch->PlayAnim2 = -1;
	}

	// ?????????????[?V?????P???????????????Q????????
	ch->PlayAnim2 = ch->PlayAnim1;
	ch->AnimPlayCount2 = ch->AnimPlayCount1;

	// ?V????w?????[?V?????????f????A?^?b?`????A?A?^?b?`???????????
	ch->PlayAnim1 = MV1AttachAnim(ch->ModelHandle, PlayAnim);
	ch->AnimPlayCount1 = 0.0f;

	// ?u?????h????????????[?V?????Q???L???????????P?D?O??( ?????????[?V?????P???P?O?O?????? )?????
	ch->AnimBlendRate = ch->PlayAnim2 == -1 ? 1.0f : 0.0f;
}

// ?L?????N?^?[??A?j???[?V????????
void Chara_AnimProcess(CHARA *ch)
{
	float AnimTotalTime; // ??????????A?j???[?V???????????

	// ?u?????h?????P????????P???????
	if (ch->AnimBlendRate < 1.0f)
	{
		ch->AnimBlendRate += CHARA_ANIM_BLEND_SPEED;
		if (ch->AnimBlendRate > 1.0f)
		{
			ch->AnimBlendRate = 1.0f;
		}
	}

	// ??????????A?j???[?V?????P?????
	if (ch->PlayAnim1 != -1)
	{
		// ?A?j???[?V?????????????èÔ
		AnimTotalTime = MV1GetAttachAnimTotalTime(ch->ModelHandle, ch->PlayAnim1);

		// ????????i???
		ch->AnimPlayCount1 += CHARA_PLAY_ANIM_SPEED;

		// ?????????????????B???????????????????[?v??????
		if (ch->AnimPlayCount1 >= AnimTotalTime)
		{
			ch->AnimPlayCount1 = fmod(ch->AnimPlayCount1, AnimTotalTime);
		}

		// ??X???????????????f??????f??????
		MV1SetAttachAnimTime(ch->ModelHandle, ch->PlayAnim1, ch->AnimPlayCount1);

		// ?A?j???[?V?????P????f?????????f?????Z?b?g
		MV1SetAttachAnimBlendRate(ch->ModelHandle, ch->PlayAnim1, ch->AnimBlendRate);
	}

	// ??????????A?j???[?V?????Q?????
	if (ch->PlayAnim2 != -1)
	{
		// ?A?j???[?V?????????????èÔ
		AnimTotalTime = MV1GetAttachAnimTotalTime(ch->ModelHandle, ch->PlayAnim2);

		// ????????i???
		ch->AnimPlayCount2 += CHARA_PLAY_ANIM_SPEED;

		// ?????????????????B???????????????????[?v??????
		if (ch->AnimPlayCount2 > AnimTotalTime)
		{
			ch->AnimPlayCount2 = fmod(ch->AnimPlayCount2, AnimTotalTime);
		}

		// ??X???????????????f??????f??????
		MV1SetAttachAnimTime(ch->ModelHandle, ch->PlayAnim2, ch->AnimPlayCount2);

		// ?A?j???[?V?????Q????f?????????f?????Z?b?g
		MV1SetAttachAnimBlendRate(ch->ModelHandle, ch->PlayAnim2, 1.0f - ch->AnimBlendRate);
	}
}

// ?L?????N?^?[??e??`??
void Chara_ShadowRender(CHARA *ch)
{
	int i;
	MV1_COLL_RESULT_POLY_DIM HitResDim;
	MV1_COLL_RESULT_POLY *HitRes;
	VERTEX3D Vertex[3];
	VECTOR SlideVec;

	// ???C?e?B???O????????
	SetUseLighting(FALSE);

	// ?y?o?b?t?@??L???????
	SetUseZBuffer3D(TRUE);

	// ?e?N?X?`???A?h???X???[?h?? CLAMP ?????( ?e?N?X?`????[?????[??h?b?g?????X???? )
	SetTextureAddressMode(DX_TEXADDRESS_CLAMP);

	// ?L?????N?^?[?????????????n???|???S?????èÔ
	HitResDim = MV1CollCheck_Capsule(stg.ModelHandle, -1, ch->Position, VAdd(ch->Position, VGet(0.0f, -CHARA_SHADOW_HEIGHT, 0.0f)), CHARA_SHADOW_SIZE);

	// ???_?f?[?^??É÷??????????????Z?b?g
	Vertex[0].dif = GetColorU8(255, 255, 255, 255);
	Vertex[0].spc = GetColorU8(0, 0, 0, 0);
	Vertex[0].su = 0.0f;
	Vertex[0].sv = 0.0f;
	Vertex[1] = Vertex[0];
	Vertex[2] = Vertex[0];

	// ???????????????|???S??????????J????
	HitRes = HitResDim.Dim;
	for (i = 0; i < HitResDim.HitNum; i++, HitRes++)
	{
		// ?|???S??????W??n??|???S??????W
		Vertex[0].pos = HitRes->Position[0];
		Vertex[1].pos = HitRes->Position[1];
		Vertex[2].pos = HitRes->Position[2];

		// ???????????ÉO??d????????????
		SlideVec = VScale(HitRes->Normal, 0.5f);
		Vertex[0].pos = VAdd(Vertex[0].pos, SlideVec);
		Vertex[1].pos = VAdd(Vertex[1].pos, SlideVec);
		Vertex[2].pos = VAdd(Vertex[2].pos, SlideVec);

		// ?|???S????s?????x??????
		Vertex[0].dif.a = 0;
		Vertex[1].dif.a = 0;
		Vertex[2].dif.a = 0;
		if (HitRes->Position[0].y > ch->Position.y - CHARA_SHADOW_HEIGHT)
			Vertex[0].dif.a = 128 * (1.0f - fabs(HitRes->Position[0].y - ch->Position.y) / CHARA_SHADOW_HEIGHT);

		if (HitRes->Position[1].y > ch->Position.y - CHARA_SHADOW_HEIGHT)
			Vertex[1].dif.a = 128 * (1.0f - fabs(HitRes->Position[1].y - ch->Position.y) / CHARA_SHADOW_HEIGHT);

		if (HitRes->Position[2].y > ch->Position.y - CHARA_SHADOW_HEIGHT)
			Vertex[2].dif.a = 128 * (1.0f - fabs(HitRes->Position[2].y - ch->Position.y) / CHARA_SHADOW_HEIGHT);

		// ?t?u?l??n??|???S????L?????N?^?[???????W??????o??
		Vertex[0].u = (HitRes->Position[0].x - ch->Position.x) / (CHARA_SHADOW_SIZE * 2.0f) + 0.5f;
		Vertex[0].v = (HitRes->Position[0].z - ch->Position.z) / (CHARA_SHADOW_SIZE * 2.0f) + 0.5f;
		Vertex[1].u = (HitRes->Position[1].x - ch->Position.x) / (CHARA_SHADOW_SIZE * 2.0f) + 0.5f;
		Vertex[1].v = (HitRes->Position[1].z - ch->Position.z) / (CHARA_SHADOW_SIZE * 2.0f) + 0.5f;
		Vertex[2].u = (HitRes->Position[2].x - ch->Position.x) / (CHARA_SHADOW_SIZE * 2.0f) + 0.5f;
		Vertex[2].v = (HitRes->Position[2].z - ch->Position.z) / (CHARA_SHADOW_SIZE * 2.0f) + 0.5f;

		// ?e?|???S????`??
		DrawPolygon3D(Vertex, 1, chcmn.ShadowHandle, TRUE);
	}

	// ???o?????n??|???S???????n??
	MV1CollResultPolyDimTerminate(HitResDim);

	// ???C?e?B???O??L???????
	SetUseLighting(TRUE);

	// ?y?o?b?t?@????????
	SetUseZBuffer3D(FALSE);
}

// ?v???C???[???????
void Player_Initialize(void)
{
	// ?L?????N?^?[??????????
	Chara_Initialize(&pl.CharaInfo, VGet(0.0f, 0.0f, 0.0f));
}

// ?v???C???[???n??
void Player_Terminate(void)
{
	// ?L?????N?^?[?????n??
	Chara_Terminate(&pl.CharaInfo);
}

// ?v???C???[?????
void Player_Process(void)
{
	VECTOR UpMoveVec;	// ?????{?^???u???v???????????????v???C???[?????????x?N?g??
	VECTOR LeftMoveVec; // ?????{?^???u???v???????????????v???C???[?????????x?N?g??
	VECTOR MoveVec;		// ????t???[???????x?N?g??
	int JumpFlag;		// ?W?????v?t???O
	int i;

	// ?v???C???[??????????x?N?g?????Z?o
	{
		// ?????{?^???u???v?????????????v???C???[?????x?N?g????J?????????????????x?????????????
		UpMoveVec = VSub(cam.Target, cam.Eye);
		UpMoveVec.y = 0.0f;

		// ?????{?^???u???v?????????????v???C???[?????x?N?g?????????????????????x?N?g????x????v???X??????x?N?g????????????
		LeftMoveVec = VCross(UpMoveVec, VGet(0.0f, 1.0f, 0.0f));

		// ????x?N?g????K??( ?x?N?g??????????P?D?O????Á∑?? )
		UpMoveVec = VNorm(UpMoveVec);
		LeftMoveVec = VNorm(LeftMoveVec);
	}

	// ????t???[????????x?N?g??????????
	MoveVec = VGet(0.0f, 0.0f, 0.0f);

	// ?W?????v?t???O??|??
	JumpFlag = 0;

	// ?p?b?h??R?{?^??????V?t?g?????????????????????????v???C???[????????
	if (CheckHitKey(KEY_INPUT_LSHIFT) == 0 && (inp.NowInput & PAD_INPUT_C) == 0)
	{
		// ?????{?^???u???v???????????J??????????????????‡Õ???????????????
		if (inp.NowInput & PAD_INPUT_LEFT)
		{
			// ????x?N?g????u???v????????????????x?N?g???????Z????
			MoveVec = VAdd(MoveVec, LeftMoveVec);
		}
		else
			// ?????{?^???u???v???????????J??????????????????‡Õ??E????????????
			if (inp.NowInput & PAD_INPUT_RIGHT)
			{
				// ????x?N?g????u???v????????????????x?N?g????]????????????Z????
				MoveVec = VAdd(MoveVec, VScale(LeftMoveVec, -1.0f));
			}

		// ?????{?^???u???v???????????J???????????????????????
		if (inp.NowInput & PAD_INPUT_UP)
		{
			// ????x?N?g????u???v????????????????x?N?g???????Z????
			MoveVec = VAdd(MoveVec, UpMoveVec);
		}
		else
			// ?????{?^???u???v???????????J?????????????????
			if (inp.NowInput & PAD_INPUT_DOWN)
			{
				// ????x?N?g????u???v????????????????x?N?g????]????????????Z????
				MoveVec = VAdd(MoveVec, VScale(UpMoveVec, -1.0f));
			}

		// ?{?^???P??????????????W?????v?t???O????
		if (inp.EdgeInput & PAD_INPUT_A)
		{
			JumpFlag = 1;
		}
	}

	// ???????????????x??X?P?[?????O????
	MoveVec = VScale(MoveVec, CHARA_MOVE_SPEED);

	// ?v???C???[?L??????O????????????s??
	for (i = 0; i < NOTPLAYER_NUM; i++)
	{
		Chara_Collision(&pl.CharaInfo, &MoveVec, &npl[i].CharaInfo);
	}

	// ?L?????N?^?[??????ËY?????s??
	Chara_Process(&pl.CharaInfo, MoveVec, JumpFlag);
}

// ?v???C???[??O?L???????????
void NotPlayer_Initialize(void)
{
	int i;
	static VECTOR FirstPosition[NOTPLAYER_NUM] =
		{
			{-3000.0f, 0.0f, 2300.0f},
			{-2500.0f, 7300.0f, -2500.0f},
			{-2600.0f, 0.0f, -3100.0f},
			{2800.0f, 0.0f, 200.0f},
		};

	for (i = 0; i < NOTPLAYER_NUM; i++)
	{
		// ?L?????N?^?[??????????
		Chara_Initialize(&npl[i].CharaInfo, FirstPosition[i]);

		// ??????????????
		npl[i].MoveTime = 0;

		// ???????????????
		npl[i].MoveAngle = GetRand(1000) * DX_PI_F * 2.0f / 1000.0f;
	}
}

// ?v???C???[??O?L???????n??
void NotPlayer_Terminate(void)
{
	int i;

	// ?L?????N?^????????J????
	for (i = 0; i < NOTPLAYER_NUM; i++)
	{
		// ?L?????N?^?[?????n??
		Chara_Terminate(&npl[i].CharaInfo);
	}
}

// ?v???C???[??O?L?????????
void NotPlayer_Process(void)
{
	int i;
	int j;
	VECTOR MoveVec;
	int JumpFlag;

	// ?L?????N?^????????J????
	for (i = 0; i < NOTPLAYER_NUM; i++)
	{
		// ?W?????v?t???O??|???????
		JumpFlag = 0;

		// ??äŒ????o???????????????????X????
		npl[i].MoveTime++;
		if (npl[i].MoveTime >= NOTPLAYER_MOVETIME)
		{
			npl[i].MoveTime = 0;

			// ?V?????????????
			npl[i].MoveAngle = GetRand(1000) * DX_PI_F * 2.0f / 1000.0f;

			// ???m????W?????v????
			if (GetRand(1000) < NOTPLAYER_JUMPRATIO)
			{
				JumpFlag = 1;
			}
		}

		// ?V??????????p?x????x?N?g?????Z?o
		MoveVec.x = cos(npl[i].MoveAngle) * CHARA_MOVE_SPEED;
		MoveVec.y = 0.0f;
		MoveVec.z = sin(npl[i].MoveAngle) * CHARA_MOVE_SPEED;

		// ?v???C???[????????????s??
		Chara_Collision(&npl[i].CharaInfo, &MoveVec, &pl.CharaInfo);

		// ??????O??v???C???[?L????????????????s??
		for (j = 0; j < NOTPLAYER_NUM; j++)
		{
			// ???????????????????
			if (i == j)
				continue;

			Chara_Collision(&npl[i].CharaInfo, &MoveVec, &npl[j].CharaInfo);
		}

		// ??????????s??
		Chara_Process(&npl[i].CharaInfo, MoveVec, JumpFlag);
	}
}

// ?X?e?[?W???????????
void Stage_Initialize(void)
{
	// ?X?e?[?W???f?????????
	stg.ModelHandle = MV1LoadModel("ColTestStage.mqo");

	// ???f???S???R???W????????Z?b?g?A?b?v
	MV1SetupCollInfo(stg.ModelHandle, -1);
}

// ?X?e?[?W???n??????
void Stage_Terminate(void)
{
	// ?X?e?[?W???f?????n??
	MV1DeleteModel(stg.ModelHandle);
}

// ?J???????????????
void Camera_Initialize(void)
{
	// ?J??????????????p?x??P?W?O?x
	cam.AngleH = DX_PI_F;

	// ?????p?x??O?x
	cam.AngleV = 0.0f;
}

// ?J?????????
void Camera_Process(void)
{
	// ?p?b?h??R?{?^?????A?V?t?g?L?[????????????????p?x??X??????s??
	if (CheckHitKey(KEY_INPUT_LSHIFT) || (inp.NowInput & PAD_INPUT_C))
	{
		// ?u???v?{?^???????????????‡‰???p?x???}?C?i?X????
		if (inp.NowInput & PAD_INPUT_LEFT)
		{
			cam.AngleH -= CAMERA_ANGLE_SPEED;

			// ?|?P?W?O?x???????????p?x?l??????????????????R?U?O?x???
			if (cam.AngleH < -DX_PI_F)
			{
				cam.AngleH += DX_TWO_PI_F;
			}
		}

		// ?u???v?{?^???????????????‡‰???p?x???v???X????
		if (inp.NowInput & PAD_INPUT_RIGHT)
		{
			cam.AngleH += CAMERA_ANGLE_SPEED;

			// ?P?W?O?x??????????p?x?l??????????????????R?U?O?x??????
			if (cam.AngleH > DX_PI_F)
			{
				cam.AngleH -= DX_TWO_PI_F;
			}
		}

		// ?u???v?{?^???????????????????p?x???}?C?i?X????
		if (inp.NowInput & PAD_INPUT_UP)
		{
			cam.AngleV -= CAMERA_ANGLE_SPEED;

			// ??????p?x?????????????????
			if (cam.AngleV < -DX_PI_F / 2.0f + 0.6f)
			{
				cam.AngleV = -DX_PI_F / 2.0f + 0.6f;
			}
		}

		// ?u???v?{?^???????????????????p?x???v???X????
		if (inp.NowInput & PAD_INPUT_DOWN)
		{
			cam.AngleV += CAMERA_ANGLE_SPEED;

			// ??????p?x????????????????
			if (cam.AngleV > DX_PI_F / 2.0f - 0.6f)
			{
				cam.AngleV = DX_PI_F / 2.0f - 0.6f;
			}
		}
	}

	// ?J??????????_??v???C???[???W????K??l?????????W
	cam.Target = VAdd(pl.CharaInfo.Position, VGet(0.0f, CAMERA_PLAYER_TARGET_HEIGHT, 0.0f));

	// ?J????????W????????
	{
		MATRIX RotZ, RotY;
		float Camera_Player_Length;
		MV1_COLL_RESULT_POLY_DIM HRes;
		int HitNum;

		// ???????????]??x????]
		RotY = MGetRotY(cam.AngleH);

		// ???????????]??y????] )
		RotZ = MGetRotZ(cam.AngleV);

		// ?J????????v???C???[??????????????Z?b?g
		Camera_Player_Length = CAMERA_PLAYER_LENGTH;

		// ?J????????W???Z?o
		// ?w????J??????v???C???[?????????????L?ÑÑ??x?N?g????
		// ??????????]( ?y????] )???????????????????]( ?x????] )????X??
		// ?????_????W???????????J????????W
		cam.Eye = VAdd(VTransform(VTransform(VGet(-Camera_Player_Length, 0.0f, 0.0f), RotZ), RotY), cam.Target);

		// ?????_????J????????W??????X?e?[?W??|???S?????????????
		HRes = MV1CollCheck_Capsule(stg.ModelHandle, -1, cam.Target, cam.Eye, CAMERA_COLLISION_SIZE);
		HitNum = HRes.HitNum;
		MV1CollResultPolyDimTerminate(HRes);
		if (HitNum != 0)
		{
			float NotHitLength;
			float HitLength;
			float TestLength;
			VECTOR TestPosition;

			// ???????·p????u???v???C???[?????

			// ?|???S??????????????????Z?b?g
			NotHitLength = 0.0f;

			// ?|???S????????˚–?????Z?b?g
			HitLength = Camera_Player_Length;
			do
			{
				// ????????????e?X?g???˚–?????Z?b?g( ??????????????????˚–??????? )
				TestLength = NotHitLength + (HitLength - NotHitLength) / 2.0f;

				// ?e?X?g?p??J???????W???Z?o
				TestPosition = VAdd(VTransform(VTransform(VGet(-TestLength, 0.0f, 0.0f), RotZ), RotY), cam.Target);

				// ?V???????W??????????e?X?g
				HRes = MV1CollCheck_Capsule(stg.ModelHandle, -1, cam.Target, TestPosition, CAMERA_COLLISION_SIZE);
				HitNum = HRes.HitNum;
				MV1CollResultPolyDimTerminate(HRes);
				if (HitNum != 0)
				{
					// ?????????????˚–???? TestLength ???X????
					HitLength = TestLength;
				}
				else
				{
					// ?????????????????????????? TestLength ???X????
					NotHitLength = TestLength;
				}

				// HitLength ?? NoHitLength ???\??????????????????‡}?[?v
			} while (HitLength - NotHitLength > 0.1f);

			// ?J????????W???Z?b?g
			cam.Eye = TestPosition;
		}
	}

	// ?J????????????C?u??????J????????f??????
	SetCameraPositionAndTarget_UpVecY(cam.Eye, cam.Target);
}

// ?`????
void Render_Process(void)
{
	int i;

	// ?X?e?[?W???f????`??
	MV1DrawModel(stg.ModelHandle);

	// ?v???C???[???f????`??
	MV1DrawModel(pl.CharaInfo.ModelHandle);

	// ?v???C???[??O?L???????f????`??
	for (i = 0; i < NOTPLAYER_NUM; i++)
	{
		MV1DrawModel(npl[i].CharaInfo.ModelHandle);
	}

	// ?v???C???[??e??`??
	Chara_ShadowRender(&pl.CharaInfo);

	// ?v???C???[??O?L??????e??`??
	for (i = 0; i < NOTPLAYER_NUM; i++)
	{
		Chara_ShadowRender(&npl[i].CharaInfo);
	}
}

// WinMain
int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nCmdShow)
{
	// ?E?C???h?E???[?h??N??
	ChangeWindowMode(TRUE);

	// ???C?u???????????
	if (DxLib_Init() < 0)
		return -1;

	// ?L?????N?^?[??????????????
	CharaCommon_Initialize();

	// ?v???C???[???????
	Player_Initialize();

	// ?v???C???[??O?L???????????
	NotPlayer_Initialize();

	// ?X?e?[?W???????
	Stage_Initialize();

	// ?J???????????
	Camera_Initialize();

	// ?`??????????
	SetDrawScreen(DX_SCREEN_BACK);

	// ?d?r?b?L?[??????????A?E?C???h?E?????????????[?v
	while (ProcessMessage() == 0 && CheckHitKey(KEY_INPUT_ESCAPE) == 0)
	{
		// ?????N???A
		ClearDrawScreen();

		// ???????
		Input_Process();

		// ?v???C???[??O?L?????????
		NotPlayer_Process();

		// ?v???C???[?????
		Player_Process();

		// ?J?????????
		Camera_Process();

		// ?`????
		Render_Process();

		// ????????e??\??????f
		ScreenFlip();
	}

	// ?v???C???[??O?L???????n??
	NotPlayer_Terminate();

	// ?v???C???[???n??
	Player_Terminate();

	// ?L?????N?^?[????????n??
	CharaCommon_Terminate();

	// ?X?e?[?W???n??
	Stage_Terminate();

	// ???C?u???????n??
	DxLib_End();

	// ?\?t?g?I??
	return 0;
}
